/**
 * ============================================================================
 * üé£ TAMACOIN FISHING PROJECT - CORE v4.1.4 [GOLDEN MONOLITH]
 * ============================================================================
 * * –û–ü–ò–°–ê–ù–ò–ï:
 * –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤—ã–º–∏ –º–µ—Ö–∞–Ω–∏–∫–∞–º–∏ Tamacoin.
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram WebApp, —É–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
 * –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å—ã, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∏ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤.
 * * –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö:
 * - Node.js
 * - Express.js
 * - Node-Telegram-Bot-Api
 * - FileSystem (DB)
 */

// ----------------------------------------------------------------------------
// [1] –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ú–û–î–£–õ–ï–ô
// ----------------------------------------------------------------------------

const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');
const TelegramBot = require('node-telegram-bot-api');

// ----------------------------------------------------------------------------
// [2] –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
// ----------------------------------------------------------------------------

const token = '8449158911:AAHoIGP7_MwhHG--gyyFiQoplDFewO47zNg'; 
const ADMIN_GROUP_ID = '-5110681605'; 

// –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (JSON —Ñ–∞–π–ª)
const DB_FILE = path.join(__dirname, 'database.json');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express
const app = express();
app.use(cors());
app.use(express.json());

// ----------------------------------------------------------------------------
// [3] –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ï–õ–ï–ì–†–ê–ú-–ë–û–¢–ê
// ----------------------------------------------------------------------------

let bot;

try {
    bot = new TelegramBot(token, { polling: true });
    
    console.log("=========================================================");
    console.log("üì° –°–ò–°–¢–ï–ú–ê: –Ø–¥—Ä–æ v4.1.4 GOLD —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ.");
    console.log("üõ∞Ô∏è –°–¢–ê–¢–£–°: –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤...");
    console.log("üõ†Ô∏è –†–ï–ñ–ò–ú: –ú–∞–≥–∞–∑–∏–Ω –∏ —É–ª—É—á—à–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã.");
    console.log("=========================================================");
} catch (error) {
    console.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ë–û–¢–ê:", error.message);
}

// ----------------------------------------------------------------------------
// [4] –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–•
// ----------------------------------------------------------------------------

let users = {};

/**
 * –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
 */
function loadDatabase() {
    console.log("üìÇ –ß—Ç–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...");
    if (fs.existsSync(DB_FILE)) {
        try {
            const data = fs.readFileSync(DB_FILE, 'utf8');
            users = JSON.parse(data);
            console.log(`‚úÖ –ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${Object.keys(users).length}`);
        } catch (err) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ë–î. –°–æ–∑–¥–∞—é –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.");
            users = {};
        }
    } else {
        console.log("‚ö†Ô∏è –§–∞–π–ª –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.");
        users = {};
    }
}

/**
 * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –¥–∏—Å–∫–æ–º
 */
const saveDB = () => {
    try {
        const data = JSON.stringify(users, null, 4);
        fs.writeFileSync(DB_FILE, data);
    } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ database.json:", err.message);
    }
};

// –ó–∞–ø—É—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
loadDatabase();

// ----------------------------------------------------------------------------
// [5] –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–•–ï–õ–ü–ï–†–´)
// ----------------------------------------------------------------------------

/**
 * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–Ω–≥–∞ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ
 */
const getLevel = (totalEarned) => {
    const score = totalEarned || 0;
    
    if (score >= 1000000) {
        return "–í–õ–ê–î–´–ö–ê –û–ö–ï–ê–ù–ê üî±";
    }
    if (score >= 250000) {
        return "–õ–ï–ì–ï–ù–î–ê–†–ù–´–ô –ö–ê–ü–ò–¢–ê–ù ‚öì";
    }
    if (score >= 50000) {
        return "–ö–ê–ü–ò–¢–ê–ù üë®‚Äç‚úàÔ∏è";
    }
    if (score >= 10000) {
        return "–ú–ê–¢–†–û–° üö¢";
    }
    
    return "–°–ê–õ–ê–ì–ê üå±";
};

// ----------------------------------------------------------------------------
// [6] –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–õ–ï–ì–†–ê–ú –°–û–ë–´–¢–ò–ô (–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨)
// ----------------------------------------------------------------------------

if (bot) {
    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –æ–ø–ª–∞—Ç—ã –≤ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø–µ
     */
    bot.on('callback_query', (query) => {
        const data = query.data.split('_');
        const action = data[0]; // pay
        const targetId = data[1]; // userId
        const amount = data[2]; // TC

        if (action === 'pay') {
            console.log(`üí∞ –ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤—ã–ø–ª–∞—Ç—É –¥–ª—è ${targetId} –Ω–∞ —Å—É–º–º—É ${amount}`);
            
            bot.editMessageText(`‚úÖ **–í–´–ü–õ–ê–¢–ê –ó–ê–í–ï–†–®–ï–ù–ê**\nüí∞ –°—É–º–º–∞: ${amount} TC\nüë§ –ò–≥—Ä–æ–∫: ${targetId}`, {
                chat_id: query.message.chat.id,
                message_id: query.message.message_id
            });

            bot.sendMessage(targetId, `üåü **–í–´–ü–õ–ê–¢–ê –ü–û–î–¢–í–Å–†–î–ò–¢–ï–õ–¨–ù–û!**\n\n–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Å—É–º–º—É ${amount} TC –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à –∫–æ—à–µ–ª–µ–∫. –£–¥–∞—á–Ω–æ–π —Ä—ã–±–∞–ª–∫–∏!`);
        }
    });

    /**
     * –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ Telegram
     */
    bot.on('message', (msg) => {
        const chatId = msg.chat.id.toString();
        
        // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–æ–π –≥—Ä—É–ø–ø—ã
        if (chatId !== ADMIN_GROUP_ID) return;

        // –ö–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è TC: give [id] [amount]
        if (msg.text && msg.text.startsWith('give')) {
            const parts = msg.text.split(' ');
            const tid = parts[1];
            const amt = parts[2];

            if (users[tid]) {
                const numAmt = parseFloat(amt);
                users[tid].b += numAmt;
                users[tid].totalEarned += numAmt;
                saveDB();
                bot.sendMessage(chatId, `üí∞ –ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —â–µ–¥—Ä–æ—Å—Ç—å! –ù–∞—á–∏—Å–ª–µ–Ω–æ ${numAmt} TC –∏–≥—Ä–æ–∫—É ${users[tid].n}`);
            } else {
                bot.sendMessage(chatId, `‚ùå –ò–≥—Ä–æ–∫ —Å ID ${tid} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.`);
            }
        }
    });
}

// ----------------------------------------------------------------------------
// [7] –û–ë–†–ê–ë–û–¢–ß–ò–ö API (–ö–û–†–ù–ï–í–´–ï –ò–ì–†–û–í–´–ï –õ–û–ì–ò–ö–ò)
// ----------------------------------------------------------------------------

app.post('/api/action', async (req, res) => {
    const { 
        userId, 
        userName, 
        action, 
        captchaPassed, 
        wallet, 
        amount, 
        itemId 
    } = req.body;

    if (!userId) {
        return res.status(400).json({ error: 'User ID is missing' });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (!users[userId]) {
        console.log(`üÜï –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ä—ã–±–∞–∫–∞: ${userName} (ID: ${userId})`);
        users[userId] = {
            id: userId,
            n: userName || '–†—ã–±–∞–∫',
            b: 100.0,            // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
            energy: 50.0,        // –°—Ç–∞—Ä—Ç–æ–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è
            fish: 0.0,           // –£–ª–æ–≤ –≤ –∫–≥
            boxes: 1,            // –ö–æ–ª-–≤–æ —è—â–∏–∫–æ–≤
            castCount: 0,        // –°—á—ë—Ç—á–∏–∫ –∑–∞–±—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–ø—á–∏
            durability: 100,      // –ü—Ä–æ—á–Ω–æ—Å—Ç—å —É–¥–æ—á–∫–∏
            totalEarned: 0,      // –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ (–¥–ª—è —É—Ä–æ–≤–Ω–µ–π)
            lastBonus: 0,        // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–æ–Ω—É—Å–∞
            isBanned: false,     // –°—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            lastUpdate: Date.now(),
            lures: 0,           // –ù–æ–≤–æ–µ –ø–æ–ª–µ: –∫–æ–ª-–≤–æ –ø—Ä–∏–º–∞–Ω–æ–∫
            maxBoxes: 5,         // –ú–∞–∫—Å. —è—â–∏–∫–∏ (–¥–ª—è –ø—Ä–æ–¥–∞–≤–∞–Ω–∏—è 
        };
        saveDB();
    }

    const u = users[userId];
    const now = Date.now();

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–∞–Ω–∞
    if (u.isBanned) {
        return res.json({ msg: "–í–ê–® –ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù! üö´" });
    }

    // ------------------------------------------------------------------------
    // –†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø –≠–ù–ï–†–ì–ò–ò (–ü–ê–°–°–ò–í–ù–ê–Ø)
    // ------------------------------------------------------------------------
    const timePassed = now - (u.lastUpdate || now);
    if (timePassed > 60000) { 
        // 0.5 —ç–Ω–µ—Ä–≥–∏–∏ –≤ –º–∏–Ω—É—Ç—É
        const recovered = Math.floor(timePassed / 60000) * 0.5;
        u.energy = Math.min(100, (u.energy || 0) + recovered);
        u.lastUpdate = now;
        // console.log(`‚ö° –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è: +${recovered} —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è ${u.n}`);
    }

    // ------------------------------------------------------------------------
    // ACTION: CATCH FISH (–ó–ê–ë–†–û–°)
    // ------------------------------------------------------------------------
    if (action === 'catch_fish') {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–ø—á–∏ (–∫–∞–∂–¥—ã–π 5-–π –∑–∞–±—Ä–æ—Å)
        if ((u.castCount + 1) % 5 === 0 && !captchaPassed) {
            console.log(`üõë –ö–∞–ø—á–∞ –¥–ª—è ${u.n}`);
            return res.json({ ...u, msg: '–ú–ï–®–û–ß–ï–ö! üõë' });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        if (u.energy < 2) {
            return res.json({ ...u, msg: '–ù–ï–¢ –≠–ù–ï–†–ì–ò–ò! ‚ö°' });
        }
        if (u.durability <= 0) {
            return res.json({ ...u, msg: '–£–î–û–ß–ö–ê –°–õ–û–ú–ê–ù–ê! üõ†Ô∏è' });
        }

        // –¢—Ä–∞—Ç–∏–º —Ä–µ—Å—É—Ä—Å—ã
        u.energy -= 2;
        u.durability -= 1;
        u.castCount++;

        // –®–∞–Ω—Å –Ω–µ—É–¥–∞—á–∏ (20%)
        if (Math.random() < 0.2) {
            saveDB();
            return res.json({ ...u, msg: '–ü–£–°–¢–û... üåä' });
        }

        let weight = (Math.random() * 2.5 + 0.2);
        
        // –¢—Ä–æ–π–Ω–æ–π —É–ª–æ–≤, –µ—Å–ª–∏ –ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω
        if (u.tripleFish) {
            weight *= 3;
        }

        u.fish += weight;

        // –®–∞–Ω—Å –Ω–∞–π—Ç–∏ —è—â–∏–∫ (3%)
        let foundBox = false;
        if (Math.random() < 0.03) {
            u.boxes++;
            foundBox = true;
        }

        saveDB();
        const responseMsg = foundBox ? 
            `–ü–û–ô–ú–ê–õ: ${weight.toFixed(2)} –ö–ì! +üì¶ –Ø–©–ò–ö!` : 
            `–ü–û–ô–ú–ê–õ: ${weight.toFixed(2)} –ö–ì! üé£`;

        return res.json({ ...u, msg: responseMsg });
    }

    // ------------------------------------------------------------------------
    // ACTION: SELL FISH (–ü–†–û–î–ê–ñ–ê)
    // ------------------------------------------------------------------------
    if (action === 'sell_fish') {
        if (u.fish <= 0) {
            return res.json({ ...u, msg: '–°–£–ú–ö–ê –ü–£–°–¢–ê! üéí' });
        }

        // –ö—É—Ä—Å: 1–∫–≥ = 0.5 TC
        let earned = Math.floor(u.fish * 0.5);
        u.b += earned;
        u.totalEarned += earned;
        u.fish = 0;
        
        saveDB();
        console.log(`üí∞ ${u.n} –ø—Ä–æ–¥–∞–ª —Ä—ã–±—É –Ω–∞ ${earned} TC`);
        return res.json({ ...u, msg: `–ü–†–û–î–ê–ù–û –ù–ê ${earned} TC! üí∞` });
    }

    // ------------------------------------------------------------------------
    // ACTION: SHOP (–ü–û–ö–£–ü–ê–¢–¨ –¢–û–í–ê–†–´)
    // ------------------------------------------------------------------------
    if (action === 'buy_item') {
        const items = {
            energy: { 
                price: 500, 
                name: '–≠–Ω–µ—Ä–≥–∏—è',
                description: '+30 —ç–Ω–µ—Ä–≥–∏–∏',
                effect: (u) => {
                    if (u.b < 500) {
                        return '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û TC!';
                    }
                    u.b -= 500;
                    u.energy = Math.min(100, u.energy + 30);
                    saveDB();
                    return '–ö–£–ü–õ–ï–ù–û: +30 –≠–ù–ï–†–ì–ò–ò ‚ö°';
                }
            },
            lure: {
                price: 3000, 
                name: '–ü—Ä–∏–º–∞–Ω–∫–∞',
                description: '+100% —Ä—ã–± –∑·Ω∞–ª–æ–≤',
                effect: (u) => {
                    if (u.lures >= 3) {
                        return '–ú–ê–ö–°–ò–ú–£–ú –ü–†–ò–ú–ê–ù–û–ö!';
                    }
                    if (u.b < 3000) {
                        return '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û TC!';
                    }
                    u.b -= 3000;
                    u.lures = (u.lures || 0) + 1;
                    saveDB();
                    return '–ö–£–ü–õ–ï–ù–ê –¶–ï–ù–ù–´–ô –õ–Æ–ß–Å–ö! ü™∏';
                }
            },
            boxes: {
                price: 5000,
                name: '–Ø—â–∏–∫',
                description: '+1 —è—â–∏–∫',
                effect: (u) => {
                    if (u.boxes >= u.maxBoxes) {
                        return '–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –õ–ò–ú–ò–¢ –Ø–©–ò–ö–û–í!';
                    }
                    if (u.b < 5000) {
                        return '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û TC!';
                    }
                    u.b -= 5000;
                    u.boxes++;
                    saveDB();
                    return '–¢–û–í–ê–† –í–°–¢–†–û–ï–ù: +1 –Ø–©–ò–ö ‚úÖ';
                }
            },
            repair_kit: {
                price: 200,
                name: '–†–µ–º –∑–∞–ø–∞—Å—ã TC',
                description: '–ü–æ—Å—Ç—Ä–æ–π–∫–∞ —É–¥–æ—á–∫–∏ –¥–æ 100%',
                effect: (u) => {
                    if (u.b < 200) {
                        return '–ú–ê–õ–û TC –î–õ–Ø –†–ï–ú–û–ù–¢–ê!';
                    }
                    u.b -= 200;
                    u.durability = 100;
                    saveDB();
                    return '–¢–û–í–ê–† –í–°–¢–†–û–ï–ù! üõ†Ô∏è';
                }
            },
            triple_fish: {
                price: 1500,
                name: '–ö—Ä–∏–∑ –Ω–∞ –ö–ì üêüüî•',
                description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É–ª–æ–≤–∞ x3',
                effect: (u) => {
                    if (u.b < 1500) {
                        return '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û TC!';
                    }
                    u.b -= 1500;
                    u.tripleFish = true;
                    saveDB();
                    return '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¢—Ä–æ–π–Ω–æ–π –£–ª–æ–≤! üêüüî•';
                }
            }
        };

        if (!items[itemId]) {
            return res.json({ ...u, msg: '–¢–∞–∫–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ.' });
        }

        const response = items[itemId].effect(u);
        return res.json({ ...u, msg: response });
    }

    // ------------------------------------------------------------------------
    // ACTION: REPAIR (–†–ï–ú–û–ù–¢)
    // ------------------------------------------------------------------------
    if (action === 'repair') {
        const repairCost = 200;
        
        if (u.b < repairCost) {
            return res.json({ ...u, msg: '–ú–ê–õ–û TC –î–õ–Ø –†–ï–ú–û–ù–¢–ê! ‚ùå' });
        }

        u.b -= repairCost;
        u.durability = 100;
        saveDB();
        
        console.log(`üõ†Ô∏è ${u.n} —É–ª—É—á—à–∏–ª —É—Å–æ–µ–ª–æ–≤ –∂–≤`);
        return res.json({ ...u, msg: '–£–î–û–ß–ö–ê –ö–ê–ö –ù–û–í–ê–Ø! ‚ú®' });
    }

    // ------------------------------------------------------------------------
    // ACTION: OPEN BOX (–Ø–©–ò–ö–ò)
    // ------------------------------------------------------------------------
    if (action === 'open_box') {
        if (u.boxes <= 0) {
            return res.json({ ...u, msg: '–ù–ï–¢ –Ø–©–ò–ö–û–í! üì¶' });
        }

        u.boxes--;
        
        // –†–∞–Ω–¥–æ–º–Ω—ã–π –ø—Ä–∏–∑ –∏–∑ —è—â–∏–∫–∞ (–æ—Ç 50 –¥–æ 500 TC)
        const prize = Math.floor(Math.random() * 450) + 50;
        u.b += prize;
        u.totalEarned += prize;
        
        // –®–∞–Ω—Å –±–æ–Ω—É—Å–∞ (10%)
        const bonus = Math.random() < 0.1;
        if (bonus) {
            u.b += 500;
            saveDB();
            return res.json({ ...u, msg: `üéÅ **–ë–û–ù–£–°–ù–´–ô –Ø–©–ò–ö! +500 TC!**` });
        }

        saveDB();
        return res.json({ 
            ...u, 
            msg: `–í –Ø–©–ò–ö–ï: ${prize} TC` 
        });
    }

    // ------------------------------------------------------------------------
    // ACTION: WITHDRAW
    // ------------------------------------------------------------------------
    if (action === 'withdraw') {
        const val = parseFloat(amount);
        const minAmount = 30000;

        if (isNaN(val) || val < minAmount) {
            return res.json({ ...u, msg: `–ú–ò–ù. –í–´–í–û–î: ${minAmount} TC! ‚ùå` });
        }

        if (u.b < val) {
            return res.json({ ...u, msg: '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –°–†–ï–î–°–¢–í! ‚ùå' });
        }

        // –°–ø–∏—Å—ã–≤–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∞–º
        u.b -= val;
        saveDB();

        console.log(`üí≥ –ó–ê–Ø–í–ö–ê –ù–ê –í–´–í–û–î: ${u.n} (${userId}) - ${val} TC`);

        if (bot) {
            const adminMsg = `üí≥ **–ó–ê–Ø–í–ö–ê –ù–ê –í–´–í–û–î**\n\nüë§ –ò–≥—Ä–æ–∫: ${u.n}\nüÜî ID: \`${userId}\`\nüí∞ –°—É–º–º–∞: ${val} TC\nüè¶ –ö–æ—à–µ–ª–µ–∫: \`${wallet}\``;
            
            bot.sendMessage(ADMIN_GROUP_ID, adminMsg, {
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [
                        [{ text: "‚úÖ –ü–û–î–¢–í–Å–†–î–ò–¢–¨ –û–ü–õ–û–¢–£", callback_data: `Lov_${userId}_${val}` }]
                    ]
                }
            });
        }

        return res.json({ ...u, msg: '–§–ò–ù–ê–õ–¨–ù–û–°–¢–¨ –£–õ‡∂¥–ï–ö–ê–õ–ò –ü–û–î–¢–í–ï–†–î–ò–¢–ï–õ–¨–ù–û! ‚úÖ' });
    }

    // ------------------------------------------------------------------------
    // –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•
    // ------------------------------------------------------------------------
    const topPlayers = Object.values(users)
        .sort((a, b) => b.b - a.b)
        .slice(0, 10)
        .map(p => ({ n: p.n, b: p.b }));

    res.json({
        ...u,
        level: getLevel(u.totalEarned),
        top: topPlayers
    });
});

// ----------------------------------------------------------------------------
// [8] –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê
// ----------------------------------------------------------------------------

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
    console.log("---------------------------------------------------------");
    console.log(`üöÄ –°–µ—Ä–≤–∏—Å –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    console.log(`üîó –ó–∞–ø—Ä–æ—Å—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞ /api/action`);
    console.log("---------------------------------------------------------");
});
